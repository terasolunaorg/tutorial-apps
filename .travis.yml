sudo: false
language: java
jdk:
  - oraclejdk8
cache:
  directories:
    - $HOME/.m2
env:
  - VERSION=1.0.0-SNAPSHOT ARCHETYPE_VERSION=5.3.0-SNAPSHOT GFW_BRANCH=master ARCHETYPE_BRANCH=master TARGET_PROJECT=target-project
  - VERSION=1.0.0-SNAPSHOT ARCHETYPE_VERSION=5.2.1-SNAPSHOT GFW_BRANCH=5.2.x ARCHETYPE_BRANCH=5.2.x TARGET_PROJECT=target-project
  - VERSION=1.0.0-SNAPSHOT ARCHETYPE_VERSION=5.2.0.RELEASE GFW_BRANCH=5.2.0.RELEASE ARCHETYPE_BRANCH=5.2.0.RELEASE TARGET_PROJECT=target-project
  - VERSION=1.0.0-SNAPSHOT ARCHETYPE_VERSION=5.1.2-SNAPSHOT GFW_BRANCH=5.1.x ARCHETYPE_BRANCH=5.1.x TARGET_PROJECT=target-project
  - VERSION=1.0.0-SNAPSHOT ARCHETYPE_VERSION=5.1.1.RELEASE GFW_BRANCH=5.1.1.RELEASE ARCHETYPE_BRANCH=5.1.1.RELEASE TARGET_PROJECT=target-project
  - VERSION=1.0.0-SNAPSHOT ARCHETYPE_VERSION=5.1.0.RELEASE GFW_BRANCH=5.1.0.RELEASE ARCHETYPE_BRANCH=5.1.0.RELEASE TARGET_PROJECT=target-project

install:
  - echo "==================== install terasoluna-gfw ===================="
  - pushd `pwd`
  - cd $HOME/build
  - if [[ -z $GFW_BRANCH ]]; then GFW_BRANCH=master; fi
  - git clone --depth=1 --branch=$GFW_BRANCH https://github.com/terasolunaorg/terasoluna-gfw.git terasolunaorg/terasoluna-gfw
  - cd terasolunaorg/terasoluna-gfw
  - bash ./mvn-build-all.sh install -Dmaven.test.skip=true -Dmaven.javadoc.skip=true -Dsource.skip=true
  - popd
  - echo "==================== install terasoluna-gfw-web-multi-blank (None) ===================="
  - if [[ -z $ARCHETYPE_BRANCH ]]; then ARCHETYPE_BRANCH=master; fi
  - pushd `pwd`
  - cd $HOME/build
  - git clone --depth=1 --branch=$ARCHETYPE_BRANCH https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank.git terasolunaorg/terasoluna-gfw-web-multi-blank
  - pushd `pwd`
  - cd terasolunaorg/terasoluna-gfw-web-multi-blank
  - sed -i -e "s/deploy/install/g" create-maven-archetype.sh
  - bash create-maven-archetype.sh
  - popd
  - rm -rf terasolunaorg/terasoluna-gfw-web-multi-blank
  - popd
  - echo "==================== install terasoluna-gfw-web-multi-blank (JPA) ===================="
  - pushd `pwd`
  - cd $HOME/build
  - git clone --depth=1 --branch=$ARCHETYPE_BRANCH https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank.git terasolunaorg/terasoluna-gfw-web-multi-blank
  - pushd `pwd`
  - cd terasolunaorg/terasoluna-gfw-web-multi-blank
  - sed -i -e "s/deploy/install/g" create-maven-archetype.sh
  - sed -i -e "s/^sh /bash /g" create-maven-archetype-jpa.sh
  - bash create-maven-archetype-jpa.sh
  - popd
  - rm -rf terasolunaorg/terasoluna-gfw-web-multi-blank
  - popd
  - echo "==================== install terasoluna-gfw-web-multi-blank (MyBatis3) ===================="
  - pushd `pwd`
  - cd $HOME/build
  - git clone --depth=1 --branch=$ARCHETYPE_BRANCH https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank.git terasolunaorg/terasoluna-gfw-web-multi-blank
  - pushd `pwd`
  - cd terasolunaorg/terasoluna-gfw-web-multi-blank
  - sed -i -e "s/deploy/install/g" create-maven-archetype.sh
  - sed -i -e "s/^sh /bash /g" create-maven-archetype-mybatis3.sh
  - bash create-maven-archetype-mybatis3.sh
  - popd
  - rm -rf terasolunaorg/terasoluna-gfw-web-multi-blank
  - popd
  - echo "==================== install terasoluna-gfw-web-blank (None) ===================="
  - pushd `pwd`
  - cd $HOME/build
  - git clone --depth=1 --branch=$ARCHETYPE_BRANCH https://github.com/terasolunaorg/terasoluna-gfw-web-blank.git terasolunaorg/terasoluna-gfw-web-blank
  - pushd `pwd`
  - cd terasolunaorg/terasoluna-gfw-web-blank
  - sed -i -e "s/deploy/install/g" create-maven-archetype.sh
  - bash create-maven-archetype.sh
  - popd
  - rm -rf terasolunaorg/terasoluna-gfw-web-blank
  - popd
  - echo "==================== install terasoluna-gfw-web-blank (JPA) ===================="
  - pushd `pwd`
  - cd $HOME/build
  - git clone --depth=1 --branch=$ARCHETYPE_BRANCH https://github.com/terasolunaorg/terasoluna-gfw-web-blank.git terasolunaorg/terasoluna-gfw-web-blank
  - pushd `pwd`
  - cd terasolunaorg/terasoluna-gfw-web-blank
  - sed -i -e "s/deploy/install/g" create-maven-archetype.sh
  - sed -i -e "s/^sh /bash /g" create-maven-archetype-jpa.sh
  - bash create-maven-archetype-jpa.sh
  - popd
  - rm -rf terasolunaorg/terasoluna-gfw-web-blank
  - popd
  - echo "==================== install terasoluna-gfw-web-blank (MyBatis3) ===================="
  - pushd `pwd`
  - cd $HOME/build
  - git clone --depth=1 --branch=$ARCHETYPE_BRANCH https://github.com/terasolunaorg/terasoluna-gfw-web-blank.git terasolunaorg/terasoluna-gfw-web-blank
  - pushd `pwd`
  - cd terasolunaorg/terasoluna-gfw-web-blank
  - sed -i -e "s/deploy/install/g" create-maven-archetype.sh
  - sed -i -e "s/^sh /bash /g" create-maven-archetype-mybatis3.sh
  - bash create-maven-archetype-mybatis3.sh
  - popd
  - rm -rf terasolunaorg/terasoluna-gfw-web-blank
  - popd

before_script:
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
  - export CARGO_DAEMON_WEBAPP_VERSION=1.4.17
  - mvn dependency:copy -Dartifact=org.codehaus.cargo:cargo-daemon-webapp:${CARGO_DAEMON_WEBAPP_VERSION}:war
  - java -jar ./cargo-daemon-webapp-${CARGO_DAEMON_WEBAPP_VERSION}.war &

script: 
  - echo "==================== Generate Tutorial Apps ===================="
  - |
    for FILE in `find ./*/scripts/create-app.sh -maxdepth 1`; do 
      echo "execute $FILE"
      bash $FILE
      buildResult=$?
      if test ${buildResult} -ne 0 ; then
        echo "[ERROR] Failed a build."
        exit ${buildResult}
      fi
    done
  - echo "==================== Build Tutorial Apps without Tests ===================="
  - |
    for POM in `find ./$TARGET_PROJECT/*/pom.xml -maxdepth 1`; do
    if test `echo $POM|grep multi`||test `echo $POM|grep session`||test `echo $POM|grep secure`;then
      PROJECTNAME=`echo $POM | cut -d "/" -f 3 `
      if test `echo $PROJECTNAME|grep secure`;then
        PROJECTNAME=${PROJECTNAME%%-demo}
      fi
      echo "build $POM"
      mvn -U -f $POM -am -pl ${PROJECTNAME}-web install
      buildResult=$?
      if test ${buildResult} -ne 0 ; then
        echo "[ERROR] Failed a build."
        exit ${buildResult}
      fi
    else
      echo "build $POM"
      mvn -U -f $POM install -DskipTests=true
      buildResult=$?
      if test ${buildResult} -ne 0 ; then
        echo "[ERROR] Failed a build."
        exit ${buildResult}
      fi
    fi
    done
  - echo "==================== Run AP And Test Tutorial Apps (e2e test) ===================="
  - |
    TESTTARGET[0]=$TARGET_PROJECT/first-spring-security-mybatis3
    TESTTARGET[1]=$TARGET_PROJECT/first-spring-security-mybatis3-multi/first-spring-security-mybatis3-multi-web
    TESTTARGET[2]=$TARGET_PROJECT/secure-login-demo/secure-login-web
    TESTTARGET[3]=$TARGET_PROJECT/session-tutorial-complete/session-tutorial-complete-web
    TESTTARGET[4]=$TARGET_PROJECT/session-tutorial-init/session-tutorial-init-web
    TESTTARGET[5]=$TARGET_PROJECT/todo
    TESTTARGET[6]=$TARGET_PROJECT/todo-mybatis3
    TESTTARGET[7]=$TARGET_PROJECT/todo-mybatis3-multi/todo-mybatis3-multi-web
    TESTTARGET[8]=$TARGET_PROJECT/todo-jpa
    TESTTARGET[9]=$TARGET_PROJECT/todo-jpa-multi/todo-jpa-multi-web
    TESTTARGET[10]=$TARGET_PROJECT/todo-api
    TESTTARGET[11]=$TARGET_PROJECT/todo-api-mybatis3
    TESTTARGET[12]=$TARGET_PROJECT/todo-api-mybatis3-multi/todo-api-mybatis3-multi-web
    TESTTARGET[13]=$TARGET_PROJECT/todo-api-jpa
    TESTTARGET[14]=$TARGET_PROJECT/todo-api-jpa-multi/todo-api-jpa-multi-web
    for WEBAPPOM in `find  ${TESTTARGET[*]} -maxdepth 1 -name pom.xml`;do
      echo "Run $WEBAPPOM"
      mvn org.codehaus.cargo:cargo-maven2-plugin:daemon-start -f $WEBAPPOM
      buildResult=$?
      if test ${buildResult} -ne 0 ; then
        echo "[ERROR] Failed a build."
        exit ${buildResult}
      fi
      if test `echo $WEBAPPOM|grep multi`||test `echo $WEBAPPOM|grep session`||test `echo $WEBAPPOM|grep secure`;then
        SELENIUMPOM="${WEBAPPOM%-web/pom.xml}-selenium/pom.xml"
      else
        SELENIUMPOM=$WEBAPPOM
      fi
      echo "Test $SELENIUMPOM"
      mvn test -f $SELENIUMPOM
      buildResult=$?
      if test ${buildResult} -ne 0 ; then
        echo "[ERROR] Failed a build."
        exit ${buildResult}
      fi
      echo "Stop $WEBAPPOM"
      mvn verify org.codehaus.cargo:cargo-maven2-plugin:daemon-stop -f $WEBAPPOM -DskipTests=true
    done
